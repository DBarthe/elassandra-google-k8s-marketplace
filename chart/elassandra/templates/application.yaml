apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  name: "{{ .Release.Name | lower }}"
  namespace: "{{ .Release.Namespace }}"
  annotations:
    kubernetes-engine.cloud.google.com/icon: >-
      data:image/png;base64,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
    kubernetes-engine.cloud.google.com/support: >-
      Strapdata provides consulting, support and enterprise grade features for elassandra.
  labels:
    app.kubernetes.io/name: "{{ .Release.Name }}"
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    app: {{ template "elassandra.name" . }}
    component: application
spec:
  descriptor:
    type: Elassandra Enterprise
    description: Elassandra is an opensource storage and search engine for large-scale real-time applications. By coupling the search engine Elasticsearch and the distributed database Apache Cassandra, Elassandra simplify your data stack and provides a strong plateforme for rich and innovative applications.
    maintainers:
    - name: Strapdata, SAS.
      url: https://www.strapdata.com
    keywords:
    - cassandra
    - elasticsearch
    - big data
    links:
    - description: GKE User Guide
      url: https://github.com/strapdata/elassandra-google-k8s-marketplace
    - description: Elassandra documentation
      url: http://doc.elassandra.io/en/latest/
    - description: Apache Cassandra documentation
      url: http://cassandra.apache.org/doc/latest/
    - description: Support
      url: https://support.strapdata.com
    notes: |-
      # Getting Started with Elassandra

      The [Elassandra on GKE User Guide](https://github.com/strapdata/elassandra-google-k8s-marketplace/) contains a lot of helpful hints on how to get started and use your elassandra cluster.

      Upon launching this application, it may take up to a few minutes for your cluster pods to be deployed, and for the elassandra cluster to fully form and become available.

      # Set env variables according to your cluster

      Set the following environnement variables according to your deployment:
      ```bash
      export NAMESPACE={{ .Release.Namespace }}
      export APP_INSTANCE_NAME={{ .Release.Name }}
      export ELASSANDRA_POD=$(kubectl get pods -n $NAMESPACE -l app=elassandra,release=$APP_INSTANCE_NAME -o jsonpath='{.items[0].metadata.name}')
      ```

      # Accessing Cassandra

      Check your cassandra cluster status by running the following commands :
      ```shell
      kubectl exec "$ELASSANDRA_POD" --namespace "$NAMESPACE" -c elassandra -- nodetool status
      ```

      Connect to Cassandra using CQLSH:
      ```shell
      kubectl exec -it "$ELASSANDRA_POD" --namespace "$NAMESPACE" -c elassandra -- cqlsh
      ```

      # Accessing Elasticsearch

      Check Elasticsearch cluster state and list indices:
      ```
      kubectl exec -it "$ELASSANDRA_POD" --namespace "$NAMESPACE" -c elassandra -- curl http://localhost:9200/_cluster/state?pretty
      kubectl exec -it "$ELASSANDRA_POD" --namespace "$NAMESPACE" -c elassandra -- curl http://localhost:9200/_cat/indices?v
      ```

      Add a JSON document:
      ```
      kubectl exec -it "$ELASSANDRA_POD" --namespace "$NAMESPACE" -c elassandra -- curl -XPUT -H "Content-Type: application/json" http://localhost:9200/test/mytype/1 -d '{ "foo":"bar" }'
      ```

      # Accessing Elassandra using the headless service

      A headless service creates a DNS record for each elassandra pod. For instance :
      ```
      $ELASSANDRA_POD.$APP_INSTANCE_NAME.default.svc.cluster.local
      ```

      Clients running inside the same k8s cluster could use thoses records to access both CQL, ES HTTP, ES transport, JMX and thrift protocols.

      # Accessing Elassandra with port forwarding

      You could also use a local proxy to access the service.

      Run the following command in a separate background terminal:
      ```shell
      kubectl port-forward "$ELASSANDRA_POD" 9042:9042 9200:9200 --namespace "$NAMESPACE"
      ```

      In you main terminal :
      ```shell
      curl localhost:9200
      cqlsh --cqlversion=3.4.4
      ```

      # Deploy a Kibana pod (requires helm installed)

      Start a Kibana pod with the same Elasticsearch version as the one provided by Elassandra. By default, Kibana connects to the Elasticsearch service on port 9200.

      ```
      helm install --namespace "$NAMESPACE" --name kibana --set image.tag=6.2.3 --set service.externalPort=5601 stable/kibana
      ```

  selector:
    matchLabels:
      app.kubernetes.io/name: "{{ .Release.Name }}"
  componentKinds:
  - group: apps/v1
    kind: Deployment
  - group: batch/v1
    kind: Job
  - group: v1
    kind: PersistentVolumeClaim
  - group: apps/v1beta2
    kind: StatefulSet
  - group: policy/v1beta1
    kind: PodDisruptionBudget
  - group: apps/v1
    kind: Secret
  - group: apps/v1
    kind: ConfigMap
  - group: apps/v1
    kind: Pod
  - group: apps/v1beta2
    kind: ReplicaSet
  - group: rbac.authorization.k8s.io/v1
    kind: Role
  - group: rbac.authorization.k8s.io/v1
    kind: RoleBinding
  - group: apps/v1
    kind: Service